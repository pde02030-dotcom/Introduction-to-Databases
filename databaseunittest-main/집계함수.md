# 🚀 SQL 집계함수

---

# 1️⃣ 집계 함수란?

집계 함수(Aggregate Function)는
**여러 행(row)을 하나의 값으로 요약하는 함수**입니다.

대표적인 집계 함수:

| 함수                  | 설명                 |
| ------------------- | ------------------ |
| **SUM()**           | 합계                 |
| **AVG()**           | 평균                 |
| **MIN()**           | 최소값                |
| **MAX()**           | 최대값                |
| **COUNT()**         | 행의 개수              |
| **COUNT(DISTINCT)** | 유니크한 행 개수          |
| **GROUP_CONCAT()**  | 그룹별 문자열 합치기(MySQL) |

집계 함수는 **SELECT 절 또는 HAVING 절에서만 사용 가능**하며
WHERE 절에서는 사용할 수 없습니다.

---

# 2️⃣ 집계 함수와 GROUP BY의 관계

집계함수는 단독으로 사용할 수도 있으나
**그룹별로 요약**해야 할 때는 GROUP BY와 함께 사용합니다.

✔ GROUP BY 없는 집계
→ 전체 행에 대해 1개의 결과만 반환

✔ GROUP BY 있는 집계
→ 각 그룹별로 1개 결과 반환

---

# 3️⃣ 실습용 테이블 생성

아래 예제는 **판매 데이터(sales)** 테이블을 사용합니다.

```sql
CREATE TABLE Sales (
    id          INT AUTO_INCREMENT PRIMARY KEY,
    product     VARCHAR(50),
    category    VARCHAR(50),
    price       INT,
    quantity    INT,
    sale_date   DATE
);
```

---

# 4️⃣ 샘플 데이터 삽입

```sql
INSERT INTO Sales (product, category, price, quantity, sale_date) VALUES
('노트북', '전자기기', 1200000, 2, '2024-01-01'),
('무선키보드', '전자기기', 45000, 5, '2024-01-01'),
('커피머신', '가전', 250000, 1, '2024-01-02'),
('노트북', '전자기기', 1200000, 1, '2024-01-03'),
('이어폰', '전자기기', 35000, 10, '2024-01-03'),
('선풍기', '가전', 55000, 4, '2024-01-03'),
('커피머신', '가전', 250000, 2, '2024-01-04'),
('노트북', '전자기기', 1200000, 3, '2024-01-04');
```

---

# 5️⃣ 집계 함수 실습 예제 + 결과 해설

---

## ✔ 예제 1) 전체 매출 합계 (SUM)

```sql
SELECT SUM(price * quantity) AS total_sales
FROM Sales;
```

### 결과

```
total_sales
----------------
6,200,000
```

SUM은 NULL을 무시합니다.

---

## ✔ 예제 2) 전체 판매 건수 (COUNT)

```sql
SELECT COUNT(*) AS total_rows FROM Sales;
```

결과:

```
8
```

### COUNT(*) vs COUNT(column)

| 함수                | 동작                   |
| ----------------- | -------------------- |
| **COUNT(*)**      | NULL 포함하여 행 개수 모두 센다 |
| **COUNT(column)** | NULL 제외              |

---

## ✔ 예제 3) 평균 판매량 (AVG)

```sql
SELECT AVG(quantity) AS avg_q
FROM Sales;
```

결과:

```
avg_q = 3.5
```

AVG 역시 NULL은 제외하고 계산.

---

## ✔ 예제 4) 가장 비싼 상품 (MAX)

```sql
SELECT MAX(price) AS max_price FROM Sales;
```

결과:

```
1200000
```

---

## ✔ 예제 5) 카테고리별 총 매출 (GROUP BY + SUM)

```sql
SELECT category, SUM(price * quantity) AS total_sales
FROM Sales
GROUP BY category;
```

결과:

| category | total_sales |
| -------- | ----------- |
| 전자기기     | 5,790,000   |
| 가전       | 410,000     |

---

## ✔ 예제 6) 제품별 총 판매 수량

```sql
SELECT product, SUM(quantity) AS total_qty
FROM Sales
GROUP BY product;
```

---

## ✔ 예제 7) 날짜별 매출 합계 + 정렬

```sql
SELECT sale_date, SUM(price * quantity) AS total_sales
FROM Sales
GROUP BY sale_date
ORDER BY sale_date;
```

---

## ✔ 예제 8) HAVING 사용 — 매출 100만 이상 날짜만 조회

```sql
SELECT sale_date, SUM(price * quantity) AS daily_sales
FROM Sales
GROUP BY sale_date
HAVING daily_sales >= 1000000;
```

HAVING은 **집계 결과에 대한 조건**에서 사용한다.
WHERE은 집계 전에 필터링.

---

## ✔ 예제 9) COUNT(DISTINCT)

```sql
SELECT COUNT(DISTINCT product) AS product_count
FROM Sales;
```

결과:

```
5
```

DISTINCT는 많은 비용이 드는 연산이므로
데이터가 많을 경우 성능 주의.

---

## ✔ 예제 10) 여러 집계 조합

```sql
SELECT
    category,
    COUNT(*) AS cnt,
    SUM(quantity) AS qty_sum,
    AVG(price) AS avg_price,
    MAX(price) AS max_price
FROM Sales
GROUP BY category;
```

---

# 6️⃣ 집계 함수 실행 원리 (전문가 수준)

MySQL/올바른 RDBMS는 다음 단계로 GROUP BY + 집계 함수를 처리한다:

---

### ✔ Step 1) WHERE 필터 적용

집계 이전에 데이터 줄이기

---

### ✔ Step 2) GROUP BY 키 기준 정렬 또는 해시 그룹핑

* MySQL: 정렬 기반 / 해시 기반 둘 다 상황에 따라 선택
* 정렬 기반이면 **Using temporary; Using filesort** 발생 → 느릴 수 있음

---

### ✔ Step 3) 각 그룹을 순회하며 집계 함수 수행

SUM, AVG, COUNT 등을 계산

---

### ✔ Step 4) HAVING 절로 집계 결과 필터링

---

### ✔ Step 5) SELECT 절 반환

---

# 7️⃣ NULL 처리 규칙

| 함수             | NULL 처리 방식 |
| -------------- | ---------- |
| **SUM()**      | NULL 무시    |
| **AVG()**      | NULL 무시    |
| **MIN/MAX**    | NULL 무시    |
| **COUNT(*)**   | NULL 포함    |
| **COUNT(col)** | NULL 제외    |

집계 함수에서 NULL을 포함한 정확한 계산이 중요하다.

---

# 8️⃣ 인덱스 성능 최적화 (전문가)

GROUP BY 또는 집계 함수가 성능이 좋아지려면 아래 조건 필요:

---

### ✔ 1) GROUP BY 컬럼에 인덱스가 있어야 정렬 비용 감소

예:

```sql
CREATE INDEX idx_sales_date ON Sales(sale_date);
```

→ filesort 유발 ↓
→ 정렬 비용 ↓

---

### ✔ 2) WHERE 조건에 인덱스가 적용되어 집계 대상 row 감소

예:

```sql
SELECT category, SUM(price)
FROM Sales
WHERE sale_date >= '2024-01-03'
GROUP BY category;
```

WHERE 인덱스 효율면 집계 속도 10배 향상 가능.

---

### ✔ 3) COUNT(*) 인덱스 활용 가능 (특정 엔진 가능)

MySQL InnoDB는 COUNT(*) 최적화를 자체적으로 수행.

---

# 9️⃣ 집계 함수 vs 윈도우 함수 차이

집계:

```
GROUP BY category
→ category 당 1개의 row 반환
```

윈도우 함수:

```
SUM(price) OVER (PARTITION BY category)
→ 그룹 내 집계를 하면서도 원본 row 유지
```

---

# 🔟 실무 수준 집계 쿼리 예시

## ✔ 카테고리별 누적 매출 (윈도우 함수)

```sql
SELECT
    category,
    sale_date,
    SUM(price * quantity) OVER(PARTITION BY category ORDER BY sale_date) AS cumulative_sales
FROM Sales;
```

---

## ✔ 전체 매출 대비 카테고리 매출 비율

```sql
SELECT 
    category,
    SUM(price * quantity) AS cate_sales,
    SUM(price * quantity) / SUM(SUM(price * quantity)) OVER() AS ratio
FROM Sales
GROUP BY category;
```

---

# ✨ 최종 요약

> **집계 함수는 여러 행을 하나의 값으로 요약하는 핵심 SQL 기능이며, GROUP BY · HAVING과 함께 사용하여 데이터 분석, 리포팅, 집계 기반 API 개발에 필수적이다.
> 성능 최적화를 위해서는 인덱스 설계, 통계(Cardinality), NULL 처리, 정렬/임시 테이블 비용을 이해하는 것이 필수이다.**


